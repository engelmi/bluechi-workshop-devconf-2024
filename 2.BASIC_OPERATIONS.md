# BlueChi workshop - Basic Operations

In this section we will be using `bluechictl` to control and monitor the system. 

First, lets connect to the container running the `bluechi-controller` and check out the commands `bluechictl` provides:

```bash
sudo podman exec -it controller /bin/bash

bluechictl version
bluechictl --help
```

## Checking and monitoring status of BlueChi nodes

In the controller container, we can use `bluechictl` to get the status of all `bluechi-agent`s (also called nodes) connected to the `bluechi-controller`:

```bash
# Check the status of all nodes
bluechictl status
# Or the status of a specific node
bluechictl status worker1
```

By adding the `-w` flag, we can continuously monitor the status of nodes: 

```bash
# Check the status of all nodes
bluechictl status -w
# Or the status of a specific node
bluechictl status worker1 -w
```

Lets try this out by stopping one of the agents! 

Keep monitoring the status of all nodes on the controller container via `bluechictl`:

```bash
bluechictl status -w
```

Then open a new terminal and connect to the worker1 container:

```bash
sudo podman exec -it worker1 /bin/bash

# stop the agent on worker1 to trigger a disconnect
systemctl stop bluechi-agent.service
```

In the terminal monitoring the bluechi-agents, the state of `worker1` changed to `offline`, and the `LAST SEEN` field was updated with a timestamp.

Lets start the agent service on the `worker1` container again:

```bash
systemctl start bluechi-agent.service
```

The state of `worker1` in the monitoring terminal should be back to `online`.


## Adding a new BlueChi node

- update controller config (add "primary")
- restart controller (currently no reload)
- bluechictl status -w (should be 2 online, primary is offline and timestamp never)
- in new terminal connect to controller container
    - update agent config (node name = primary)
    - systemctl start bluechi-agent
- in monitoring terminal, primary should be online

## Listing services on BlueChi nodes

- bluechictl list-units (and filter)


## Controlling service lifecycle on BlueChi nodes

The container images come preinstalled with a systemd service running an Apache HTTP Server. Let's start it on `worker1`

```
bluechictl start worker1 httpd.service
bluechictl enable worker1 httpd.service
```

Since all the containers are configured with the host network, you can navigate to
```
http://127.0.0.1:8088/
```
to make sure that `httpd` is running.

Check the `httpd.service` status with `bluechictl`, and review the output

```
bluechictl status worker1 httpd.service
```

The following systemd lifecycle operations are available:

```
bluechictl [start|stop|freeze|thaw|reload|restart|enable|disable] <node> <service>
```

Important: BlueChi controls the services, but is not needed for them to run! You can take down all the BlueChi services, and the Apache Server will continue working:

```bash
exit
sudo podman exec -it controller systemctl stop bluechi-controller.service
sudo podman exec -it worker1 systemctl stop bluechi-agent.service
sudo podman exec -it worker2 systemctl stop bluechi-agent.service
```

Check that http://127.0.0.1:8088/ still can be accessed.

Restart all the BlueChi services:

```bash
sudo podman exec -it controller systemctl start bluechi-controller.service
sudo podman exec -it worker1 systemctl start bluechi-agent.service
sudo podman exec -it worker2 systemctl start bluechi-agent.service
sudo podman exec -it controller /bin/bash
bluechictl status
```


## Monitoring services

A user can create monitors, which basically tells `bluechi-controller` to send signals on different events. In the `monitoring terminal`:

```bash
bluechictl monitor # Monitor all signals from all nodes and for all units
# or
bluechictl monitor worker1 # Monitor signals from worker1 for all units
# or
bluechictl monitor worker1 httpd.service # Monitor signals from worker1 for httpd
```

In the other terminal start and stop `httpd.service`, and review all the property change events. Also, unit status can be monitored with `status -w` command:

```
bluechictl status worker1 httpd.service -w
```

__Note:__ BlueChi provides a [DBus API](https://bluechi.readthedocs.io/en/latest/api/description/), thus all of functionalities shown here are directly available on DBus or can be implemented using bindings from different languages, like Python, Go and Rust.

---

[< Back](1.SETUP.md) | [Next >](3.DEPLOY_APPLICATION.md)
